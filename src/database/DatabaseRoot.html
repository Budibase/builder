<script>

import HierarchyRow from "./HierarchyRow.html";
import RecordView from "./RecordView.html";
import {hierarchy, selectedNodeId, currentNode} from "../builderStore";
import getIcon from "../common/icon";
import DropdownButton from "../common/DropdownButton.html";
import {hierarchy as hierarchyFunctions} from "budibase-core";
import {makeNewChildRecord, makeNewChildIndex, 
    NewRootRecord, NewRootIndex} from "../builderStore/currentNode";

const defaultNewIndexActions = [{
    label:"New Root Index", 
    onclick: () => selectedNodeId.set(NewRootIndex)
}];

const defaultNewRecordActions = [{
    label:"New Root Record", 
    onclick: () => selectedNodeId.set(NewRootRecord)
}];

let newIndexActions = defaultNewIndexActions;
let newRecordActions = defaultNewRecordActions;

currentNode.subscribe(n => {
    if(hierarchyFunctions.isIndex(n)) {
        newIndexActions = [
            ...defaultNewIndexActions,
            {label: `New Index on ${n.name}`, 
            onclick: () => selectedNodeId.set(
                makeNewChildIndex(n.nodeId))
        }
        ];

        newRecordActions = defaultNewRecordActions;

    } else {
        newRecordActions = [
            ...defaultNewRecordActions,
            {label: `New Child Record of ${n.name}`, 
            onclick: () => selectedNodeId.set(
                makeNewChildRecord(n.nodeId))
        }
        ];

        newIndexActions = defaultNewIndexActions;
    }
});


</script>

<div class="root">
    <div class="hierarchy">
        <div class="hierarchy-title-row">
            <div class="hierarchy-title">Records</div>
            <DropdownButton iconName="plus" actions={newRecordActions} />
        </div>
        {#each $hierarchy.children as record}
        <HierarchyRow node={record} />
        {/each}

        <div class="hierarchy-title-row" style="margin-top: 20px">
            <div class="hierarchy-title">Indexes</div>
            <DropdownButton iconName="plus" actions={newIndexActions} />
        </div>
        {#each $hierarchy.indexes as index}
        <HierarchyRow node={index} />
        {/each}
    </div>
    <div class="node-container">
        {#if !$currentNode}
        <h1>nothing selected</h1>
        {:else}
        <RecordView record={$currentNode} />
        {/if}
    </div>
</div>


<style>
.root {
    display: flex;
    height: 100%;
    position: relative;
}

.hierarchy {
    flex: 0 1 auto;
    width: 200px;
    background-color: var(--primary10);
    overflow-y: auto;
    height: 100%;
}

.node-container {
    flex: 1 1 auto;
    overflow-y: auto;
}

.hierarchy-title-row {
    padding: 15px 7px;
    /*background-color: var(--secondary75);
    color: var(--white);*/
    font-size: 11pt;
    display: flex;
    font-weight: bold;
}

.hierarchy-title {
    flex: auto 1 1;
}


</style>